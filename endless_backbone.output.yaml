name: endless_backbone_output
type: output
status: beta

fields:
  - name: scope
    type: string
    description: the scope to use for the event
  - name: key
    type: string
    description: the key to use for the event
    default: "${! meta(\"io.shono.key\") }"
  - name: debug
    type: bool
    default: false
    description: whether to enable debug logging

mapping: |-
  map backbone {
    root.kafka_franz.seed_brokers = [ env("BACKBONE_KAFKA_URL") ]
    root.kafka_franz.sasl = [
      {
        "mechanism": "PLAIN",
        "username": env("BACKBONE_KAFKA_USERNAME"),
        "password": env("BACKBONE_KAFKA_PASSWORD")
      }
    ]
    root.kafka_franz.tls.enabled = true
    root.kafka_franz.topic = this.scope
    root.kafka_franz.metadata.include_patterns = [ "io.shono..*" ]
    root.kafka_franz.key = this.key
  }
  
  map debug {
    root.stdout.codec = "lines"
  }
  
  root = if this.debug {
    this.apply("debug")
  } else {
    {
      "switch": {
        "cases": [
          {
            "check": "!errored()",
            "output": this.apply("backbone")
          },
          {
            "output": {
              "reject": "Unable to process message: ${! error() }",
              "processors": [
                {
                  "log": {
                    "level": "ERROR",
                    "message": "Unable to process message: ${! error() }"
                  }
                }
              ]
            }
          }
        ]
      }
    }
  }

tests:
  - name: Test With Kafka
    config:
      scope: govuk
      app: companies_injector
      key: "${this.key}"
    expected:
      switch:
        cases:
          - check: "!errored()"
            output:
              kafka_franz:
                seed_brokers:
                  -
                sasl:
                  - mechanism: PLAIN
                    username:
                    password:
                tls:
                  enabled: true
                topic: govuk
                metadata:
                  include_patterns:
                    - ".*"
                key: "${this.key}"
                batching:
                  count: 50
                  period: 1s
          - output:
              reject: "Unable to process message: ${! error() }"

  - name: Test With Debug
    config:
      scope: govuk
      key: "${this.key}"
      debug: true
    expected:
      stdout:
        codec: lines