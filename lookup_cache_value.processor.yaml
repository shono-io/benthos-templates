name: lookup_cache_value
type: processor
status: beta
description: look for a value in redis

fields: 
  - name: cache
    type: string
    description: the cache to use to perform the lookup
  - name: prefix
    type: string
    default: "values"
    description: the prefix to use for the keys in redis
  - name: concept_field
    type: string
    default: "concept"
    description: the dot path to the field holding the concept identifier
  - name: key_field
    type: string
    default: "key"
    description: the dot path to the field holding the key identifier
  - name: result_map
    type: string
    default: |-
      root = this
    description: the mapping to use to map the result of the redis lookup
  - name: escape_key
    type: bool
    default: true
    description: whether to escape the key before using it in the redis lookup

mapping: |-
  map get_link {
    let pref = if this.prefix != null && this.prefix != "" {
      this.prefix + ":"
    } else {
      ""
    }
  
    root.cache.resource = this.cache
    root.cache.operator = "get"
    root.cache.key = "${! \"%s%%s:%%s\".format(this.concept, this.key) }".format($pref) 
  }
  
  map link_value_lookup {
    root.branch.request_map = """
  root.concept = this.get(%[1]q)
  root.key = if this.exists(%[2]q) && this.get(%[2]q) != null {
    if this.escape_key { this.get(%[2]q).string().escape_url_query() } else { this.get(%[2]q).string() }
  }
  
  root.key = if this.escape_key { root.key.escape_url_query() } else { root.key }
  
  root = if root.exists("key") && root.key != null {
    root
  } else {
    deleted()
  }""".format(this.concept_field, this.key_field)
  
    root.branch.processors = [ 
      {
        "try": [
          {"log": {
            "level": "DEBUG",
            "message": "get ${! \"values:%s:%s\".format(this.concept, this.key)}"
          }},
          this.apply("get_link"),
          {"mapping": "root = this"}
        ]
      },
      {
        "catch": [
          {"mapping": "root.concept = deleted()\nroot.key = deleted()"}
        ]
      }
    ]
    root.branch.result_map = this.result_map
  }
  
  root = this.apply("link_value_lookup")

tests:
  - name: Should generate template
    config:
      cache: "mycache"
    expected:
      branch:
        request_map: |-
          root.concept = this.get("concept")
          root.key = if this.exists("key") && this.key != null {
            this.get("key").escape_url_query()
          }
          
          root = if root.exists("key") && root.key != null {
            root
          } else {
            deleted()
          }
        processors:
          - try:
            - log:
                level: DEBUG
                message: "get ${! \"values:%s:%s\".format(this.concept, this.key)}"
            - cache:
                resource: mycache
                operator: get
                key: ${! "values:%s:%s".format(this.concept, this.key) }

            - mapping: root = this

          - catch:
            - mapping: |-
                root.concept = deleted()
                root.key = deleted()
              

        result_map: |-
          root = this