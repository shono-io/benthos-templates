name: kv_set
type: processor
status: beta
description: set a key to a value in the key value store

fields: 
  - name: redis
    type: string
    description: the redis url to use
  - name: key
    type: string
    description: the dot path to the field containing the key
  - name: scope
    type: string
    description: the scope
  - name: concept
    type: string
    description: the concept
  - name: prefix
    type: string
    default: ""
    description: the prefix to use for the key

mapping: |-
  map kv_set {
    let prefix = if this.prefix != "" { "%s:".format(this.prefix) } else { "" }
    
    root.redis.url = this.redis
    root.redis.command = "set"
    root.redis.args_mapping = """root = [
    "%s%s:%%s".format(%s.escape_url_query()),
    this.format_json()
  ]""".format($prefix, this.concept, this.key)
  }
  
  root.branch.processors = []
  root.branch.processors."-".try = [
    this.apply("kv_set"),
    {"metric": { "type": "counter", "name": "io_shono_concept_stored", "labels": { "app": "${APP_ID}", "kind": "state", "scope": this.scope, "concept": this.concept } }}
  ]
  root.branch.processors."-".catch = [
    {"metric": { "type": "counter", "name": "io_shono_concept_store_failed", "labels": { "app": "${APP_ID}", "kind": "state", "scope": this.scope, "concept": this.concept } }}
  ]

tests:
  - name: Should generate template
    config:
      redis: ${REDIS_URL}/4
      scope: "exact"
      key: this.code
      concept: "appellation"
    expected:
      branch:
        processors:
          - try:
            - redis:
                url: ${REDIS_URL}/4
                command: set
                args_mapping: |-
                  root = [
                    "appellation:%s".format(this.code.escape_url_query()),
                    this.format_json()
                  ]

            - metric:
                type: counter
                name: "io_shono_concept_stored"
                labels:
                  app: "${APP_ID}"
                  kind: "state"
                  scope: "exact"
                  concept: "appellation"
          - catch:
              - metric:
                  type: counter
                  name: "io_shono_concept_store_failed"
                  labels:
                    app: "${APP_ID}"
                    kind: "state"
                    scope: "exact"
                    concept: "appellation"