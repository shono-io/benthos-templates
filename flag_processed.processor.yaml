name: flag_processed
type: processor
status: beta

fields:
  - name: redis
    type: string
    default: "${REDIS_URL}"
    description: the redis url to use
  - name: scope
    type: string
    default: "${APP_SCOPE}"
    description: the processing scope
  - name: concept
    type: string
    description: the concept of the current message
  - name: key
    type: string
    description: the expression to retrieve the key from the current message

mapping: |-
  map kv_set {
    root.label = "flag_%s_as_processed".format(this.concept)
    root.redis.url = this.redis
    root.redis.command = "set"
    root.redis.args_mapping = """root = [
    "%s:dependencies:%s:%%s".format(%s.escape_url_query()),
    now()
  ]""".format(this.scope, this.concept, this.key)
  }
  
  root.branch.processors = []
  root.branch.processors."-" = this.apply("kv_set")

tests:
  - name: Test
    config:
      redis: ${REDIS_URL}
      scope: "exact"
      concept: "account"
      key: "this.AccountId"
    expected:
      branch:
        processors:
          - label: flag_account_as_processed
            redis:
              url: ${REDIS_URL}
              command: set
              args_mapping: |-
                root = [
                  "exact:dependencies:account:%s".format(this.AccountId.escape_url_query()),
                  now()
                ]